{% extends "base.html" %}
{% block title %}Entrega y Pago | PetFun{% endblock %}
{% block content %}

<div class="checkout-container">
  <h1>Entrega y Pago</h1>

  <form method="post" id="checkout-form">
    {% csrf_token %}

    <div class="checkout-card">
      <h3>Datos de contacto</h3>
      <label>Email</label>
      <input type="text" name="email" required value="{{ initial.email|default:'' }}" />
      
      <h3>Dirección de envío</h3>
      <label>Nombre</label>
      <input type="text" name="ship_name" required value="{{ initial.ship_name|default:'' }}" />
      <label>Calle</label>
      <input type="text" name="ship_street" required value="{{ initial.ship_street|default:'' }}" />
      <label>Número</label>
      <input type="text" name="ship_number" required value="{{ initial.ship_number|default:'' }}" />
      <label>Piso</label>
      <input type="text" name="ship_floor" value="{{ initial.ship_floor|default:'' }}" />
      <label>Ciudad</label>
      <input type="text" name="ship_city" required value="{{ initial.ship_city|default:'' }}" />
      <label>Código Postal</label>
      <input type="text" name="ship_postal_code" required value="{{ initial.ship_postal_code|default:'' }}" />
      <label>País</label>
      <input type="text" name="ship_country" required value="{{ initial.ship_country|default:'' }}" />
    </div>

    <div class="checkout-card">
      <h3>Método de pago</h3>
      <p>Tarjeta (Stripe)</p>
      {% if not STRIPE_PUBLISHABLE_KEY %}
        <p class="warning">Claves de Stripe no configuradas. Añade STRIPE_SECRET_KEY y STRIPE_PUBLISHABLE_KEY en .env para poder pagar.</p>
      {% endif %}

      {% if stripe_client_secret %}
        <div id="payment-element"></div>
        <button type="button" class="btn-pay" id="btn-pay">Pagar ahora</button>
        <p class="hint">Introducirás una tarjeta de prueba. Te redirigiremos para confirmar si es necesario.</p>
      {% else %}
        <button type="submit" class="btn-pay">Proceder al pago</button>
        <p class="hint">Se creará un Payment Intent de Stripe y, a continuación, podrás introducir la tarjeta.</p>
      {% endif %}
    </div>
  </form>
</div>

<style>
.checkout-container {
  max-width: 700px;
  margin: 0 auto;
  padding: 20px 16px;
}

.checkout-card {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.checkout-card h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: #111;
}

.checkout-card label {
  font-weight: 600;
  margin-top: 6px;
}

.checkout-card input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  width: 100%;
  box-sizing: border-box;
}

#payment-element {
  padding: 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.06);
  margin-top: 6px;
  margin-bottom: 12px;
}

.btn-pay {
  padding: 12px 20px;
  background: #f9a825;
  color: #06141b;
  border: 0;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s ease;
}
.btn-pay:hover {
  background: #ffbf3f;
}

.warning {
  color: #f7bfa0;
  font-size: 14px;
}

.hint {
  opacity: 0.7;
  font-size: 14px;
  margin-top: 6px;
}
</style>

{% if stripe_client_secret %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
const options = { clientSecret: "{{ stripe_client_secret }}" };
const elements = stripe.elements(options);
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');

document.getElementById('btn-pay').addEventListener('click', async () => {
  document.getElementById('btn-pay').disabled = true;
  const {error} = await stripe.confirmPayment({
    elements,
    confirmParams: { return_url: "{{ stripe_return_url }}" }
  });
  if(error){
    alert(error.message || 'Error al confirmar el pago');
    document.getElementById('btn-pay').disabled = false;
  }
});
</script>
{% endif %}

{% endblock %}
