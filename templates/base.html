<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}PetFun{% endblock %}</title>
  <style>
      :root{--bg:#0b132b;--card:#1c2541;--accent:#5bc0be;--text:#eaeaea;--muted:#9aa0a6;}
      *{box-sizing:border-box}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
      header{padding:16px 24px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
      .brand{font-weight:700;letter-spacing:.3px}
  .container{max-width:960px;margin:28px auto;padding:0 16px}
      .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:20px}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
  #side-cart{position:sticky;top:16px;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;height:auto;max-height:70vh;overflow:auto}
  #side-cart h3{margin-top:0}
  #side-cart-list .cart-row{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
  #side-cart .controls{display:flex;gap:6px;align-items:center;margin:6px 0}
  #side-cart .btn-remove{background:#c44;color:#fff;border:0;border-radius:6px;padding:4px 8px}
      input[type=text],input[type=password]{width:100%;padding:12px 14px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text)}
      button{background:var(--accent);color:#06141b;border:0;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
      a{color:var(--accent);text-decoration:none}
      .row{display:flex;gap:16px;flex-wrap:wrap}
      .grow{flex:1 1 360px}
      .messages{margin:0 0 12px 0;padding:0;list-style:none}
      .messages li{padding:10px 12px;border-radius:8px;margin-bottom:8px}
      .messages .success{background:#123; border:1px solid #2a7}
      .messages .error{background:#301; border:1px solid #c44}
    </style>
  </head>
  <body>
    <header>
      <div class="brand">üêæ PetFun</div>
      <nav>
        <a href="/" style="margin-right:12px">Inicio</a>
  <a href="/catalog/" style="margin-right:12px">Productos</a>
        <a href="/track/" style="margin-right:12px">Seguimiento</a>
        {% if request.user.is_authenticated %}
          <span style="margin-right:12px; color:var(--muted)">Hola, {{ request.user.first_name|default:request.user.email }}</span>
          {% if request.user.is_staff %}
            <a href="/admin/" style="margin-right:12px">Admin</a>
          {% endif %}
          <a href="{% url 'account' %}" style="margin-right:12px">Mi cuenta</a>
          <a href="{% url 'logout' %}">Cerrar sesi√≥n</a>
        {% else %}
          <a href="{% url 'login' %}" style="margin-right:12px">Iniciar sesi√≥n</a>
          <a href="{% url 'register' %}">Crear cuenta</a>
        {% endif %}
      </nav>
    </header>
    <div class="container">
      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      <div class="layout">
        <main>
          {% block content %}{% endblock %}
        </main>
        <aside id="side-cart">
          <h3>üõí Cesta</h3>
          <div id="side-cart-list">
            {% if cart %}
              {% for it in cart.items.all %}
              <div class="cart-row" data-pid="{{ it.product_id }}">
                <div class="name">{{ it.product.name }}</div>
                <div class="controls">
                  <button class="qty-minus">-</button>
                  <input id="qty-{{ it.product_id }}" type="number" min="1" value="{{ it.quantity }}" style="width:50px" />
                  <button class="qty-plus">+</button>
                  <button class="btn-remove" title="Eliminar">√ó</button>
                </div>
                <div class="prices">{{ it.unit_price }} ‚Ç¨ x {{ it.quantity }} = <strong>{{ it.subtotal }} ‚Ç¨</strong></div>
              </div>
              {% empty %}
                <div class="muted">Tu cesta est√° vac√≠a.</div>
              {% endfor %}
            {% endif %}
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <strong>Total:</strong>
            <strong id="side-cart-total">{{ cart.total|default:0 }} ‚Ç¨</strong>
          </div>
          <div style="margin-top:10px;text-align:right">
            <a href="/checkout/" id="btn-checkout" class="button" style="background:var(--accent);color:#06141b;padding:8px 12px;border-radius:8px;display:inline-block">Ir a pagar</a>
          </div>
        </aside>
      </div>
    </div>
    <script>
      // Global cart helpers
      function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():''}
      const CSRFTOKEN = getCookie('csrftoken');

      async function addToCart(productId, quantity=1){
        const res = await fetch('{% url "cart:add" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId, quantity})});
        const data = await res.json();
        renderCart(data);
      }
      async function updateQty(productId, quantity){
        const res = await fetch('{% url "cart:update" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId, quantity})});
        const data = await res.json();
        renderCart(data);
      }
      async function removeItem(productId){
        const res = await fetch('{% url "cart:remove" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId})});
        const data = await res.json();
        renderCart(data);
      }
      function renderCart(data){
        const c = document.querySelector('#side-cart-list');
        if(!c) return;
        c.innerHTML = '';
        data.items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'cart-row';
          row.dataset.pid = it.product_id;
          row.innerHTML = `
            <div class="name">${it.name}</div>
            <div class="controls">
              <button class="qty-minus">-</button>
              <input id="qty-${it.product_id}" type="number" min="1" value="${it.quantity}" style="width:50px" />
              <button class="qty-plus">+</button>
              <button class="btn-remove" title="Eliminar">√ó</button>
            </div>
            <div class="prices">${it.unit_price} ‚Ç¨ x ${it.quantity} = <strong>${it.subtotal} ‚Ç¨</strong></div>
          `;
          c.appendChild(row);
        });
        const t = document.querySelector('#side-cart-total');
        if(t) t.textContent = (data.total || '0.00') + ' ‚Ç¨';
        try{
          const itemsCount = (data.items || []).length;
          if(itemsCount === 0 && window.location.pathname.startsWith('/checkout/')){
            window.location.href = '/';
          }
        }catch(_e){}
      }
      document.addEventListener('click', (e) => {
        if(e.target.classList.contains('btn-add')){
          if(e.target.disabled) return;
          const pid = e.target.dataset.productId;
          if(!pid) return;
          // try to find a sibling qty input
          let q = 1;
          const card = e.target.closest('.card');
          if(card){
            const inpt = card.querySelector('.qty-input');
            if(inpt){
              const v = parseInt(inpt.value || '1');
              q = isNaN(v) ? 1 : Math.max(1, v);
            }
          }
          addToCart(pid, q);
        }
        if(e.target.classList.contains('qty-minus') || e.target.classList.contains('qty-plus')){
          const row = e.target.closest('[data-pid]');
          if(!row) return;
          const pid = row.dataset.pid;
          const input = document.querySelector(`#qty-${pid}`);
          let q = parseInt((input && input.value) || '1');
          if(e.target.classList.contains('qty-minus')) q = Math.max(1, q-1); else q = q+1;
          updateQty(pid, q);
        }
        if(e.target.classList.contains('btn-remove')){
          const row = e.target.closest('[data-pid]');
          if(!row) return;
          const pid = row.dataset.pid;
          removeItem(pid);
        }
        if(e.target.id === 'btn-checkout'){
          const hasItems = document.querySelectorAll('#side-cart-list .cart-row').length > 0;
          if(!hasItems){
            e.preventDefault();
            alert('Tu cesta est√° vac√≠a. A√±ade productos antes de ir a pagar.');
          }
        }
      });
      document.addEventListener('change', (e) => {
        if(e.target && e.target.matches('input[id^="qty-"]')){
          const input = e.target;
          const pid = input.id.replace('qty-','');
          const val = parseInt(input.value || '1');
          const q = isNaN(val) ? 1 : Math.max(1, val);
          if(String(q) !== String(input.value)) input.value = q;
          updateQty(pid, q);
        }
      });
    </script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
