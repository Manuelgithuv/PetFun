<!doctype html>
{% load static %}
{% load catalog_extras %}
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}PetFun{% endblock %}</title>
  <link rel="icon" href="{% static 'Logo.png' %}">
  <style>
    :root{
      --bg:rgb(255, 252, 242);
      --accent:#f9a825;
      --text:#1a1a1a;
      --muted:#666;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}
    a{color:#333;text-decoration:none;}
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      border-bottom:1px solid #ddd;
      background:rgb(255, 252, 242);
      flex-wrap:wrap;
      gap:8px;
    }
    .brand img{height:32px; border-radius:8px;}
    .header-nav a, .header-nav span{margin-left:16px; font-weight:500;}
    @media(max-width:768px){
      header{flex-direction:column; align-items:flex-start;}
      .header-nav a, .header-nav span{margin-left:0;margin-right:12px;}
    }

    /* Hero global */
    .pf-hero-wrapper {
      padding:80px 0;
      background: url("{% static 'Banner.png' %}") center/cover no-repeat;
      position: relative;
      border-bottom:1px solid rgba(0,0,0,0.05);
    }
    .pf-hero-wrapper::before{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.28);
    }
    .pf-hero {
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      gap:40px;
      align-items:flex-start;
      position:relative;
      z-index:2;
    }
    .pf-hero-left { 
      flex:1; 
      color:#06141b; 
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:16px;
      max-width:50%;
    }
    .pf-hero-title { font-size:48px; font-weight:900; margin:0; color:#06141b; line-height:1; }
    .pf-btn { background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; font-weight:700; border: none; cursor:pointer;}
    @media(max-width:980px){
      .pf-hero { flex-direction:column; padding:0 20px; align-items:flex-start;}
      .pf-hero-left { max-width:100%; }
      .pf-hero-title { font-size:34px; }
    }

.quick-cats {
  display: flex;
  gap: 16px;
  padding-left: 24px; /* mismo que el logo */
  background: rgb(255, 252, 242);
}

.quick-cats .dropdown {
  position: relative;
}

.quick-cats .dropdown a {
  text-decoration: none;
  color: #06141b;
  font-weight: 700;
  padding: 6px 8px;
  display: inline-block;
}

.quick-cats .dropdown-content {
  display: none;
  position: absolute;
  top: 100%; /* justo debajo del enlace padre */
  left: 0;
  background: rgb(255, 252, 242);
  min-width: 180px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  z-index: 10;
  flex-direction: column;
}

.quick-cats .dropdown-content a {
  padding: 8px 12px;
  color: #06141b;
  font-weight: 500;
}

.quick-cats .dropdown-content a:hover {
  background: #f9f9f9;
}

.quick-cats .dropdown:hover .dropdown-content {
  display: flex; /* se muestra al pasar el rat√≥n */
  flex-direction: column;
}
/* === Side Cart Moderno === */

/* === SIDE CART MODERNO === */

.side-cart {
  position: fixed;
  right: 16px;
  top: 80px;
  width: 330px;
  background: #fff;
  border-radius: 18px;
  padding: 18px;
  max-height: 75vh;
  overflow-y: auto;
  z-index: 2000;
  border: 1px solid #e8e3dc;
  box-shadow: 0 10px 28px rgba(0,0,0,0.12);
}

.side-cart-title {
  margin: 0 0 14px;
  font-size: 20px;
  font-weight: 800;
  color: #222;
}

.side-cart-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.cart-row {
  display: flex;
  gap: 12px;
  background: #faf7f3;
  border: 1px solid #e7dfd8;
  padding: 12px;
  border-radius: 12px;
  align-items: center;
}

.cart-img {
  width: 80px;          /* ancho fijo */
  height: 80px;         /* alto fijo */
  object-fit: contain;   /* mantiene proporci√≥n sin recortar */
  border-radius: 10px;
  border: 1px solid #e0d8cf;
  background: #fff;      /* fondo blanco para espacios vac√≠os */
}

.cart-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.qty-select {
  width: 70px;
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #d6cfc7;
  background: #fff;
  font-size: 14px;
}
.cart-name {
  font-weight: 600;
  font-size: 15px;
  color: #333;
}

.cart-total-item {
  font-size: 15px;
  color: #444;
}

.btn-remove {
  background: #ffe5e5;
  border: 1px solid #ffcccc;
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 18px;
  cursor: pointer;
  color: #a33;
  align-self: flex-start;
}
.btn-remove:hover {
  background: #ffdcdc;
}

.side-cart-footer {
  margin-top: 18px;
  border-top: 1px solid #e7e0d7;
  padding-top: 14px;
  display: flex;
  justify-content: space-between;
  font-size: 17px;
}

.side-cart-checkout {
  margin-top: 14px;
}

.checkout-btn {
  display: block;
  background: var(--accent);
  padding: 12px 16px;
  text-align: center;
  font-weight: 700;
  border-radius: 12px;
  color: #06141b;
  text-decoration: none;
  box-shadow: 0 4px 10px rgba(0,0,0,.15);
}
.checkout-btn:hover {
  opacity: .9;
}

.msg-wrapper {
  width: 100%;
  max-width: 1200px;
  margin: 10px auto 0;
  padding: 0 24px;
}

.msg {
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 8px;
  font-weight: 600;
}

.msg-success {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
}

.msg-info {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  color: #0c5460;
}

.msg-warning {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
}

.msg-error {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}

  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <a class="brand" href="/"><img src="{% static 'Logo.png' %}" alt="PetFun"></a>
    <nav class="header-nav">
      {% if request.user.is_authenticated %}
        <span>Hola, {{ request.user.first_name|default:request.user.email }}</span>
        {% if request.user.is_staff %}<a href="/admin/">Admin</a>{% endif %}
        <a href="{% url 'account' %}">Mi cuenta</a>
        <a href="{% url 'logout' %}">Cerrar sesi√≥n</a>
      {% else %}
        <a href="{% url 'login' %}">Iniciar sesi√≥n</a>
        <a href="{% url 'register' %}">Crear cuenta</a>
      {% endif %}
         <a href="/track/" style="margin-right:12px">Seguimiento</a>
          {% if request.path != '/checkout/' %}
          
       <aside id="side-cart" class="side-cart">
  <h3 class="side-cart-title">üõí Tu Cesta</h3>

  <div id="side-cart-list" class="side-cart-list">
    {% for it in cart.items.all %}
      <div class="cart-row" data-pid="{{ it.product_id }}">

        <!-- Imagen del producto -->
        <img class="cart-img" src="{% product_image_src it.product %}" alt="{{ it.product.name }}">

        <div class="cart-content">

          <div class="cart-name">{{ it.product.name }}</div>

          <!-- Cantidad con dropdown -->
          <select class="qty-select" data-pid="{{ it.product_id }}" data-quantity="{{ it.quantity }}"></select>



          <!-- Solo el precio TOTAL del art√≠culo -->
          <div class="cart-total-item">
            <strong>{{ it.subtotal }} ‚Ç¨</strong>
          </div>

          <button class="btn-remove">√ó</button>

        </div>
      </div>
    {% empty %}
      <div class="side-cart-empty">Tu cesta est√° vac√≠a.</div>
    {% endfor %}
  </div>

  <div class="side-cart-footer">
    <span>Total:</span>
    <strong id="side-cart-total">{{ cart.total|default:0 }} ‚Ç¨</strong>
  </div>

  <div class="side-cart-checkout">
    <a href="/checkout/" class="checkout-btn">Ir a pagar</a>
  </div>
</aside>
 {% endif %}

  


    </nav>

    {% if request.user.is_authenticated %}
    <!-- Categor√≠as r√°pidas: Perros y Gatos -->
    <div class="quick-cats-wrapper" style="width:100%; background:white;">
      <nav class="quick-cats">
        <div class="dropdown">
          <a href="/catalog/?parent=Juguetes para Perro">Perros ‚ñæ</a>
          <div class="dropdown-content">
            <a href="/catalog/?parent=Juguetes para Perro&sub=De inteligencia">De inteligencia</a>
            <a href="/catalog/?parent=Juguetes para Perro&sub=Mordedores">Mordedores</a>
            <a href="/catalog/?parent=Juguetes para Perro&sub=Pelotas">Pelotas</a>
            <a href="/catalog/?parent=Juguetes para Perro&sub=Peluches">Peluches</a>
          </div>
        </div>

        <div class="dropdown">
          <a href="/catalog/?parent=Juguetes para Gato">Gatos ‚ñæ</a>
          <div class="dropdown-content">
            <a href="/catalog/?parent=Juguetes para Gato&sub=Ca√±a">Ca√±a</a>
            <a href="/catalog/?parent=Juguetes para Gato&sub=Hierba gatera">Hierba gatera</a>
            <a href="/catalog/?parent=Juguetes para Gato&sub=Ratones de juguete">Ratones de juguete</a>
            <a href="/catalog/?parent=Juguetes para Gato&sub=T√∫neles">T√∫neles</a>
          </div>
        </div>
      </nav>
    </div>
    {% endif %}
  </header>

  {% if messages %}
    <div class="msg-wrapper">
      {% for message in messages %}
        <div class="msg msg-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% if request.path != '/login/' and request.path != '/register/' and request.path != '/account/' %}
    <!-- Hero global -->
    <section class="pf-hero-wrapper">
      <div class="pf-hero">
        <div class="pf-hero-left">
          <h1 class="pf-hero-title">Todo para tus mascotas en un solo lugar üêæ</h1>
          <button class="pf-btn" type="button" onclick="window.location.href='/catalog/'">Ver Cat√°logo</button>
        </div>
        <div class="pf-hero-right" aria-hidden="true"></div>
      </div>
    </section>
  {% endif %}

  {% block content %}{% endblock %}


  <!-- Scripts y carrito -->
   <script>
      // Global cart helpers
      function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return m?m.pop():''}
      const CSRFTOKEN = getCookie('csrftoken');

      async function addToCart(productId, quantity=1){
        const res = await fetch('{% url "cart:add" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId, quantity})});
        const data = await res.json();
        renderCart(data);
      }
      async function updateQty(productId, quantity){
        const res = await fetch('{% url "cart:update" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId, quantity})});
        const data = await res.json();
        renderCart(data);
      }
      async function removeItem(productId){
        const res = await fetch('{% url "cart:remove" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN}, body: JSON.stringify({product_id: productId})});
        const data = await res.json();
        renderCart(data);
      }
     function renderCart(data){
    const c = document.querySelector('#side-cart-list');
    if(!c) return;
    c.innerHTML = '';

    data.items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.dataset.pid = it.product_id;

        // Generar opciones 1-10
        let options = '';
        for(let n=1; n<=10; n++){
            options += `<option value="${n}" ${n === it.quantity ? 'selected' : ''}>${n}</option>`;
        }

        row.innerHTML = `
            <img class="cart-img" src="${it.image_url}" alt="${it.name}">
            <div class="cart-content">
              <div class="cart-name">${it.name}</div>
              <select class="qty-select" data-pid="${it.product_id}">
                ${[...Array(10).keys()].map(n => `<option value="${n+1}" ${n+1 === it.quantity ? 'selected' : ''}>${n+1}</option>`).join('')}
              </select>
              <div class="cart-total-item"><strong>${it.subtotal} ‚Ç¨</strong></div>
              <button class="btn-remove">√ó</button>
            </div>
          `;


        c.appendChild(row);
    });

    const t = document.querySelector('#side-cart-total');
    if(t) t.textContent = (data.total || '0.00') + ' ‚Ç¨';
}



      document.addEventListener('click', (e) => {
        if(e.target.classList.contains('btn-add')){
          if(e.target.disabled) return;
          const pid = e.target.dataset.productId;
          if(!pid) return;
          // try to find a sibling qty input
          let q = 1;
          const card = e.target.closest('.card');
          if(card){
            const inpt = card.querySelector('.qty-input');
            if(inpt){
              const v = parseInt(inpt.value || '1');
              q = isNaN(v) ? 1 : Math.max(1, v);
            }
          }
          addToCart(pid, q);
        }
        if(e.target.classList.contains('qty-minus') || e.target.classList.contains('qty-plus')){
          const row = e.target.closest('[data-pid]');
          if(!row) return;
          const pid = row.dataset.pid;
          const input = document.querySelector(`#qty-${pid}`);
          let q = parseInt((input && input.value) || '1');
          if(e.target.classList.contains('qty-minus')) q = Math.max(1, q-1); else q = q+1;
          updateQty(pid, q);
        }
        if(e.target.classList.contains('btn-remove')){
          const row = e.target.closest('[data-pid]');
          if(!row) return;
          const pid = row.dataset.pid;
          removeItem(pid);
        }
        if(e.target.id === 'btn-checkout'){
          const hasItems = document.querySelectorAll('#side-cart-list .cart-row').length > 0;
          if(!hasItems){
            e.preventDefault();
            alert('Tu cesta est√° vac√≠a. A√±ade productos antes de ir a pagar.');
          }
        }
      });
      document.addEventListener('change', (e) => {
        if(e.target && e.target.matches('input[id^="qty-"]')){
          const input = e.target;
          const pid = input.id.replace('qty-','');
          const val = parseInt(input.value || '1');
          const q = isNaN(val) ? 1 : Math.max(1, val);
          if(String(q) !== String(input.value)) input.value = q;
          updateQty(pid, q);
        }
      });
      document.querySelectorAll('.qty-select').forEach(sel => {
  const currentQty = parseInt(sel.dataset.quantity || 1);
  sel.innerHTML = [...Array(10).keys()]
    .map(n => `<option value="${n+1}" ${n+1 === currentQty ? 'selected' : ''}>${n+1}</option>`)
    .join('');
});
      document.addEventListener('change', (e) => {
        if(e.target.classList.contains('qty-select')){
          const pid = e.target.dataset.pid;
          const qty = parseInt(e.target.value || '1');
          updateQty(pid, qty);
        }
      });

const sideCart = document.querySelector('#side-cart-list');

sideCart.addEventListener('click', (e)=>{
    const row = e.target.closest('.cart-row');
    if(!row) return;
    const pid = row.dataset.pid;

    if(e.target.classList.contains('btn-remove')){
        removeItem(pid);
    }
});

sideCart.addEventListener('change', (e)=>{
    if(e.target.classList.contains('qty-select')){
        const pid = e.target.dataset.pid;
        const qty = parseInt(e.target.value);
        updateQty(pid, qty);
    }
});



    </script>


</body>
</html>
